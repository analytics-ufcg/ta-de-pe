<div
  class="view-container"
  [hidden]="!contrato">

  <app-barra-titulo
    [titulo]="'Contrato ' + contrato?.nr_contrato + '/' + contrato?.ano_contrato"
    [subtitulo]="contrato?.nm_orgao"
    [exibirVoltar]="true"></app-barra-titulo>

  <div class="container">
    <app-spinner *ngIf="isLoading"></app-spinner>
    <div class="row mt-4">
      <div class="col-sm-12 col-md-3 mb-4">
        <div class="dados-linha">
          <strong>Licitação</strong>
        </div>
        <div class="dados-linha">
          <a [routerLink]="['/licitacoes/' + contrato?.id_licitacao + '/info/']">
            {{ contrato?.nr_licitacao }}/{{ contrato?.ano_licitacao }}
          </a>
        </div>
      </div>
      <div class="col-sm-12 col-md-9 mb-4">
        <div class="dados-linha">
          <strong>Fornecedor</strong>
        </div>
        <div class="dados-linha">
          {{ contrato?.contratoFornecedor.nm_pessoa }}
          <span class="text-muted">
            ({{ contrato?.nr_documento_contratado | formatCpfCnpj }})
          </span>
        </div>
      </div>
      <div class="col-sm-6 col-md-6 col-lg-3 mb-4">
        <div class="dados-linha">
          <strong>Vigência</strong>
        </div>
        <div class="dados-linha">
          {{ contrato?.dt_inicio_vigencia | date: "dd/MM/yyyy" }} à {{ contrato?.dt_final_vigencia | date: "dd/MM/yyyy" }}
        </div>
      </div>
      <div class="col-sm-6 col-md-6 col-lg-3 mb-4">
        <div class="dados-linha">
          <strong>Valor</strong>
        </div>
        <div class="dados-linha">
          {{ contrato?.vl_contrato | currency: "R$" }}
          <div class="mt-2">
            <app-progress
              [value]="contrato?.total_pago"
              [max]="contrato?.valor_contratado"
              [class]="'bg-info'"></app-progress>
            <span
              *ngIf="contrato?.valor_contratado > 0"
              class="text-contrato-progress">
              <small>
                {{ contrato?.total_pago / contrato?.valor_contratado | percent }} do valor contratado já foi pago.
              </small>
            </span>
          </div>
        </div>
      </div>
      <div class="col-sm-6 col-md-6 col-lg-6 mb-4">
        <div class="dados-linha">
          <strong>Diferença com Estimado</strong>

          <app-tooltip-ajuda
            [posicao]="'top'"
            [descricao]="'Diferença em R$ entre o valor do contrato e o valor estimado na licitação'"></app-tooltip-ajuda>
        </div>
        <div class="dados-linha">
          <span *ngIf="contrato?.valor_contratado - contrato?.valor_estimado === 0">Sem diferença</span>
          <span *ngIf="contrato?.valor_contratado - contrato?.valor_estimado < 0">
            {{ contrato?.valor_contratado - contrato?.valor_estimado  | currency: "R$" }}
            <span class="text-muted">(mais barato)</span>
          </span>
          <span *ngIf="contrato?.valor_contratado - contrato?.valor_estimado > 0">
            {{ contrato?.valor_contratado - contrato?.valor_estimado  | currency: "+R$" }}
            <span class="text-muted">(mais caro)</span>
          </span>
        </div>
      </div>
    </div>

    <div class="contrato-corpo">
      <div class="table-responsive">
        <table class="table table-sm">
          <thead>
            <tr>
              <th class="head-controls">&nbsp;</th>
              <th
                class="head-controls text-right"
                colspan="6">
                <form [formGroup]="radioGroupForm">
                  <div class="toggle-wrapper toggle-wrapper-right">
                    <span class="toggle-label">Unidade</span>
                    <input
                      class="toggle toggle-flat"
                      id="cb4"
                      type="checkbox"
                      formControlName="showTotal"
                      [value]="true"
                      checked>
                    <label
                      class="toggle-btn"
                      for="cb4"></label>
                    <span class="toggle-label">Total</span>
                  </div>
                </form>
              </th>
            </tr>
            <tr>
              <th
                scope="col"
                class="text-left table-th-dividido-up align-middle">
                Item
              </th>
              <th
                scope="col"
                class="table-th-monospace table-th-dividido-up text-right"
                *ngIf="!radioGroupForm.value['showTotal']">
                <span class="nowrap">Valor por</span>
                <br>
                unidade
                <br>
                (R$)
              </th>
              <th
                scope="col"
                class="table-th-monospace table-th-dividido-up text-right"
                *ngIf="radioGroupForm.value['showTotal']">
                <span class="nowrap">Valor total</span>
                <br>
                (R$)
              </th>
              <th
                scope="col"
                class="table-th-monospace table-th-dividido-up text-right">
                Mediana
                <br>
                <span class="nowrap">no estado</span>
                <br>
                (R$)
                <app-tooltip-ajuda [descricao]="'Mediana do preço de produtos similares contratados em municípios do estado seis meses antes ou depois da data do contrato'"></app-tooltip-ajuda>
              </th>
              <th
                scope="col"
                class="table-th-monospace table-th-dividido-up text-right">
                Diferença
                <br>
                <span class="nowrap">com estado</span>
                <br>
                (%)
                <app-tooltip-ajuda [descricao]="'Diferença percentual entre o valor contratado e o valor mediano de produtos similares contratados em municípios do estado'"></app-tooltip-ajuda>
              </th>
              <th
                scope="col"
                class="table-th-monospace table-th-dividido-up text-right">
                Valor
                <br>
                estimado
                <br>
                (R$)
                <app-tooltip-ajuda [descricao]="'Valor de referência obtido através de orçamentos feitos pelo ente público; uma previsão de quanto será gasto no contrato'"></app-tooltip-ajuda>
              </th>
              <th
                scope="col"
                class="table-th-monospace table-th-dividido-up text-right">
                Diferença
                <br>
                <span class="nowrap">com estimado</span>
                <br>
                (%)
                <app-tooltip-ajuda
                  [posicao]="'left'"
                  [descricao]="'Diferença percentual entre o valor contratado e o valor estimado'"></app-tooltip-ajuda>
              </th>
            </tr>
          </thead>
          <tbody>
            <tr
              *ngFor="let item of contrato?.itensContrato; index as i"
              class="table-item">
              <td class="text-nowrap align-middle">
                <a [routerLink]="['/itens/'+ item.id_item_contrato]">
                {{ item.ds_item | resumirTexto }}
                </a>
                <span class="text-muted">
                  ({{ item.qt_itens_contrato }} {{ item.itensLicitacaoItensContrato.sg_unidade_medida | lowercase }})
                </span>
                <button
                  (click)="open(content, item)"
                  class="btn btn-secondary btn-sm">
                  ...
                </button>
              </td>
              <td
                class="numero align-middle"
                *ngIf="!radioGroupForm.value['showTotal']">
                {{ item.vl_item_contrato | currency:'':'' }}
              </td>
              <td
                class="numero align-middle"
                *ngIf="radioGroupForm.value['showTotal']">
                {{ item.vl_total_item_contrato | currency:'':'' }}
              </td>
              <td
                class="numero align-middle"
                *ngIf="!radioGroupForm.value['showTotal']"
                [title]="item.mediana_valor">
                {{ item.mediana_valor | currency:'':'' }}
              </td>
              <td
                class="numero align-middle"
                *ngIf="radioGroupForm.value['showTotal']"
                [title]="item.mediana_valor * item.qt_itens_contrato">
                {{ item.mediana_valor * item.qt_itens_contrato | currency:'':'' }}
              </td>
              <td
                class="numero align-middle"
                [title]="item.mediana_valor"
                [style.background-color]="defineCorFundo(item.percentual_vs_estado)"
                [style.color]="defineCor(item.percentual_vs_estado)">
                <span *ngIf="item.percentual_vs_estado > 0">+</span>{{ item.percentual_vs_estado | percent:'1.1' }}
              </td>
              <td
                class="numero align-middle"
                *ngIf="!radioGroupForm.value['showTotal']"
                [title]="item.itensLicitacaoItensContrato.vl_unitario_estimado">
                {{ item.itensLicitacaoItensContrato.vl_unitario_estimado | currency:'':'' }}
              </td>
              <td
                class="numero align-middle"
                *ngIf="radioGroupForm.value['showTotal']"
                [title]="item.itensLicitacaoItensContrato.vl_unitario_estimado * item.qt_itens_contrato">
                {{ item.qt_itens_contrato * item.itensLicitacaoItensContrato.vl_unitario_estimado | currency:'':'' }}
              </td>
              <td
                class="numero align-middle"
                [title]="item.itensLicitacaoItensContrato.vl_unitario_estimado"
                [style.background-color]="defineCorFundo(item.percentual_vs_estimado)"
                [style.color]="defineCor(item.percentual_vs_estimado)">
                <span *ngIf="item.percentual_vs_estimado > 0">+</span>{{ item.percentual_vs_estimado | percent:'1.1' }}
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Template do modal que exibe os detalhes de um item -->
<ng-template
  #content
  let-modal>
  <div class="modal-header">
    <h5 class="modal-title">Detalhes do item</h5>
    <button
      type="button"
      class="close"
      data-dismiss="modal"
      aria-label="Fechar"
      (click)="modal.dismiss()">
      <span aria-hidden="true">&times;</span>
    </button>
  </div>
  <div class="modal-body">

    <div class="row item-destaque-wrapper">
      <div class="col-12">
        <strong>Descrição</strong>
      </div>
      <div class="col-lg-7 pb-4">{{ itemSelecionado.ds_item }}</div>
      <div class="col-lg-5">

        <div class="row">
          <div class="col-md-6">

            <div>
              <strong>Valor por unidade</strong>
            </div>
            <div class="numero numero-destaque">
              {{ itemSelecionado.vl_item_contrato | currency:'R$' }}
            </div>

          </div>
          <div class="col-md-6">

            <div>
              <strong>Mediana do estado</strong>
            </div>
            <div class="numero numero-destaque">
              {{ itemSelecionado.mediana_valor | currency:'R$' }}
            </div>
             <div *ngIf="itemSelecionado.vl_item_contrato - itemSelecionado.mediana_valor !== 0">
              <span
                *ngIf="itemSelecionado.vl_item_contrato - itemSelecionado.mediana_valor < 0"
                class="positivo">
                {{ itemSelecionado.vl_item_contrato - itemSelecionado.mediana_valor | currency:'':'' }}
                    ({{ (itemSelecionado.vl_item_contrato - itemSelecionado.mediana_valor) / itemSelecionado.mediana_valor | percent:'1.1' }})
              </span>
              <span
                *ngIf="itemSelecionado.vl_item_contrato - itemSelecionado.mediana_valor > 0"
                class="negativo">
                +{{ itemSelecionado.vl_item_contrato - itemSelecionado.mediana_valor | currency:'':'' }}
                    ({{ (itemSelecionado.vl_item_contrato - itemSelecionado.mediana_valor) / itemSelecionado.mediana_valor | percent:'1.1' }})
              </span>
            </div>

          </div>
        </div>

      </div>
    </div>

    <h4>Comparação do item com seus similares</h4>

    <div class="table-responsive">
      <table class="table table-sm">
        <thead>
          <tr>
            <th
              scope="col"
              class="align-middle">
              Itens similares
            </th>
            <th
              scope="col"
              class="table-th-monospace">
              Município
            </th>
            <th
              scope="col"
              class="table-th-monospace text-center">
              Ano
            </th>
            <th
              scope="col"
              class="table-th-monospace text-right">
              Valor por
              <br>
              unidade (R$)
            </th>
            <th
              scope="col"
              class="table-th-monospace text-right">
              Diferença
              <app-tooltip-ajuda
                [posicao]="'top'"
                [descricao]="'Diferença percentual entre o valor do item e itens similares em outros contratos'"></app-tooltip-ajuda>
              <br>
              c/ similar (%)
            </th>
            <th
              scope="col"
              class="table-th-monospace text-right">
              &nbsp;
            </th>
          </tr>
        </thead>
        <tbody>
          <tr
            *ngFor="let item of itemSelecionado?.itensSemelhantes; index as i"
            class>
            <td class="align-middle">
              <details>
                <summary>{{ item.ds_item | resumirTexto }}...</summary>
                <p>{{ item.ds_item }}</p>
              </details>
            </td>
            <td class="align-middle">{{ item.nome_municipio }}</td>
            <td class="align-middle text-center">{{ item.ano_licitacao }}</td>
            <td class="numero align-middle">
              {{ item.vl_item_contrato | currency:'':'' }}
            </td>
            <td
              class="numero align-middle"
              [style.background-color]="defineCorFundo(item.percentual_vs_semelhante)"
              [style.color]="defineCor(item.percentual_vs_semelhante)">
              <span *ngIf="item.percentual_vs_semelhante > 0">+</span>{{ item.percentual_vs_semelhante | percent:'1.1' }}
            </td>
            <td class="align-middle">
              <div class="ml-2">
                <a
                  [routerLink]="['/contratos/' + item.id_contrato]"
                  target="_blank"
                  class="btn btn-light btn-sm text-nowrap">
                  <span class="icon-arrow-right"></span>
                  Ver contrato
                </a>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

  </div>
  <div class="modal-footer">
    <button
      type="button"
      class="btn btn-primary"
      (click)="modal.close('Fechar')">
      Fechar
    </button>
  </div>
</ng-template>
